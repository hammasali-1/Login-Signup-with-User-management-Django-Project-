<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inbox</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <style>:root{--radius:.9rem}.card{border-radius:var(--radius)}.unread{background:rgba(34,197,94,.08)}.read{background:transparent}</style>
</head>
<body style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">
    <style>
        .modal{z-index:11000}
        .modal-backdrop{z-index:10900}
    </style>
    {% include 'partials/navbar.html' %}
    <div id="spa-content">
    <div class="container py-4">
        <div class="row g-4">
            <div class="col-12">
                <div class="card p-3">
                    <div class="row g-3">
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Total: <span id="stTotal">{{ stats.total }}</span></div></div>
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Read: <span id="stRead">{{ stats.read }}</span></div></div>
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Unread: <span id="stUnread">{{ stats.unread }}</span></div></div>
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Resolved: <span id="stResolved">{{ stats.resolved }}</span></div></div>
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Unresolved: <span id="stUnresolved">{{ stats.unresolved }}</span></div></div>
                        <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Deleted: <span id="stDeleted">{{ stats.deleted }}</span></div></div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <form class="d-flex flex-wrap gap-2" method="get">
                            <input id="searchBox" type="search" class="form-control" name="q" value="{{ q }}" placeholder="Search by username, email, subject or text">
                            <select id="roleFilter" class="form-select" name="role" style="max-width:180px">
                                <option value="">All roles</option>
                                <option value="admin" {% if role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="manager" {% if role == 'manager' %}selected{% endif %}>Manager</option>
                                <option value="user" {% if role == 'user' %}selected{% endif %}>User</option>
                            </select>
                            <input id="startFilter" type="text" class="form-control" name="start" value="{{ start }}" style="max-width:220px" placeholder="YYYY-MM-DD HH:MM" title="Use YYYY-MM-DD HH:MM or YYYY-MM-DDTHH:MM">
                            <input id="endFilter" type="text" class="form-control" name="end" value="{{ end }}" style="max-width:220px" placeholder="YYYY-MM-DD HH:MM" title="Use YYYY-MM-DD HH:MM or YYYY-MM-DDTHH:MM">
                            <button class="btn btn-light" type="submit">Apply</button>
                            <button id="clearFilters" class="btn btn-outline-secondary" type="button">Clear</button>
                        </form>
                        <form id="bulkForm" method="post" action="{% url 'inbox_bulk_action' %}">
                            {% csrf_token %}
                            <div class="d-flex gap-2">
                                <select name="action" class="form-select" style="max-width: 200px">
                                    <option value="read">Mark Read</option>
                                    <option value="unread">Mark Unread</option>
                                    <option value="resolve">Resolve</option>
                                    <option value="unresolve">Unresolve</option>
                                    <option value="delete">Delete</option>
                                </select>
                                <button type="submit" class="btn btn-outline-primary">Apply</button>
                            </div>
                        </form>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Subject</th>
                                    <th>Sent</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="inboxRows">
                                {% for m in messages_list %}
                                <tr class="{% if not m.is_read %}unread{% else %}read{% endif %}">
                                    <td>{{ forloop.counter }}</td>
                                    <td><input type="checkbox" name="ids" form="bulkForm" value="{{ m.id }}"></td>
                                    <td><a href="{% url 'inbox_user' user_id=m.user_id %}">{{ m.username|default:'-' }}</a></td>
                                    <td>{{ m.email|default:'-' }}</td>
                                    <td>{{ m.subject|default:'-' }}</td>
                                    <td>{{ m.created_at }}</td>
                                    <td>
                                        {% if m.is_read %}<span class="badge bg-success">Read</span>{% else %}<span class="badge bg-secondary">Unread</span>{% endif %}
                                        {% if m.is_resolved %}<span class="badge bg-primary ms-1">Resolved</span>{% else %}<span class="badge bg-warning text-dark ms-1">Unresolved</span>{% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#view{{ m.id }}">View</button>
                                        <a href="{% url 'inbox_delete_message' id=m.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this message?')">Delete</a>
                                    </td>
                                </tr>
                                <div class="modal fade" id="view{{ m.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                        <div class="modal-header"><h5 class="modal-title">Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                        <div class="modal-body">
                                            <div>Username: {{ m.username|default:'-' }}</div>
                                            <div>Email: {{ m.email|default:'-' }}</div>
                                            <div>Role: {% if m.user %}{{ m.user.role }}{% else %}-{% endif %}</div>
                                            <div>Sent: {{ m.created_at }}</div>
                                            <hr>
                                            <div><strong>Subject:</strong> {{ m.subject|default:'(no subject)' }}</div>
                                            <div>{{ m.message|linebreaks }}</div>
                                        </div>
                                            <div class="modal-footer">
                                                <form method="post" action="{% url 'inbox_bulk_action' %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="ids" value="{{ m.id }}">
                                                    <div class="btn-group">
                                                        <button name="action" value="read" class="btn btn-outline-success" type="submit">Read</button>
                                                        <button name="action" value="unread" class="btn btn-outline-secondary" type="submit">Unread</button>
                                                        <button name="action" value="resolve" class="btn btn-outline-primary" type="submit">Resolve</button>
                                                        <button name="action" value="unresolve" class="btn btn-outline-warning" type="submit">Unresolve</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="modalsContainer"></div>
                    <script data-spa-init>
                        (function(){
                            var sel=document.getElementById('selectAll');
                            if(sel){sel.addEventListener('change',function(){document.querySelectorAll('input[name="ids"]').forEach(function(c){c.checked=sel.checked})})}
                            function getCookie(name){var v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop():''}
                            var rows=document.getElementById('inboxRows');
                            var mods=document.getElementById('modalsContainer');
                            var qBox=document.getElementById('searchBox');
                            var roleSel=document.getElementById('roleFilter');
                            var startInput=document.getElementById('startFilter');
                            var endInput=document.getElementById('endFilter');
                            var clearBtn=document.getElementById('clearFilters');
                            function render(data){
                                document.getElementById('stTotal').textContent=data.stats.total;
                                document.getElementById('stRead').textContent=data.stats.read;
                                document.getElementById('stUnread').textContent=data.stats.unread;
                                document.getElementById('stResolved').textContent=data.stats.resolved;
                                document.getElementById('stUnresolved').textContent=data.stats.unresolved;
                                document.getElementById('stDeleted').textContent=data.stats.deleted;
                                var html=''; var mod='';
                                data.messages.forEach(function(m,i){
                                    html += '<tr class="'+(m.is_read?'read':'unread')+'">\n'
                                         + '<td>'+(i+1)+'</td>'
                                         + '<td><input type="checkbox" name="ids" form="bulkForm" value="'+m.id+'"></td>'
                                         + '<td>'+m.username+'</td>'
                                         + '<td>'+m.email+'</td>'
                                         + '<td>'+m.subject+'</td>'
                                         + '<td>'+m.created_at+'</td>'
                                         + '<td>'+(m.is_read? '<span class="badge bg-success">Read</span>' : '<span class="badge bg-secondary">Unread</span>') + (m.is_resolved? '<span class="badge bg-primary ms-1">Resolved</span>' : '<span class="badge bg-warning text-dark ms-1">Unresolved</span>') + '</td>'
                                         + '<td><button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#view'+m.id+'">View</button> '
                                         + '<a href="{% url 'inbox_delete_message' id=0 %}'.replace('0',m.id)+'" class="btn btn-sm btn-danger" onclick="return confirm(\'Delete this message?\')">Delete</a></td>'
                                         + '</tr>';
                                    mod += '<div class="modal fade" id="view'+m.id+'" tabindex="-1" aria-hidden="true">\n'
                                         + '<div class="modal-dialog"><div class="modal-content">\n'
                                         + '<div class="modal-header"><h5 class="modal-title">Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>\n'
                                         + '<div class="modal-body">\n'
                                         + '<div>Username: '+m.username+'</div><div>Email: '+m.email+'</div><div>Role: '+m.user_role+'</div><div>Sent: '+m.created_at+'</div><hr>\n'
                                         + '<div><strong>Subject:</strong> '+(m.subject||'(no subject)')+'</div><div>'+m.message+'</div>\n'
                                         + '</div>\n'
                                         + '<div class="modal-footer">\n'
                                         + '<div class="btn-group">\n'
                                         + '<button data-id="'+m.id+'" data-action="read" class="btn btn-outline-success js-inbox-action" type="button">Read</button>\n'
                                         + '<button data-id="'+m.id+'" data-action="unread" class="btn btn-outline-secondary js-inbox-action" type="button">Unread</button>\n'
                                         + '<button data-id="'+m.id+'" data-action="resolve" class="btn btn-outline-primary js-inbox-action" type="button">Resolve</button>\n'
                                         + '<button data-id="'+m.id+'" data-action="unresolve" class="btn btn-outline-warning js-inbox-action" type="button">Unresolve</button>\n'
                                         + '</div></div></div></div></div>';
                                });
                                rows.innerHTML=html; mods.innerHTML=mod;
                                mods.querySelectorAll('.modal').forEach(function(mdl){
                                    mdl.addEventListener('shown.bs.modal', function(){
                                        var id=this.id.replace('view','');
                                        fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:'read'})}).catch(function(){})
                                    });
                                });
                                mods.querySelectorAll('.js-inbox-action').forEach(function(btn){
                                    btn.addEventListener('click', function(){
                                        var id=this.getAttribute('data-id'); var a=this.getAttribute('data-action');
                                        fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:a})}).then(function(){poll()}).catch(function(){});
                                    });
                                });
                            }
                            function buildQuery(){
                                var q = qBox ? qBox.value.trim() : '';
                                var role = roleSel ? roleSel.value : '';
                                var start = startInput ? startInput.value : '';
                                var end = endInput ? endInput.value : '';
                                var p = new URLSearchParams();
                                if(q) p.set('q', q);
                                if(role) p.set('role', role);
                                if(start) p.set('start', start);
                                if(end) p.set('end', end);
                                return p.toString();
                            }
                            function poll(){
                                var qs = buildQuery();
                                var url = '{% url 'inbox_data' %}' + (qs? ('?'+qs):'');
                                fetch(url).then(function(r){return r.json()}).then(function(data){if(data&&data.ok) render(data)}).catch(function(){});
                            }
                            var debounce;
                            function trigger(){ clearTimeout(debounce); debounce=setTimeout(poll,250) }
                            if(qBox){ qBox.addEventListener('input', trigger) }
                            if(roleSel){ roleSel.addEventListener('change', trigger) }
                            if(startInput){ startInput.addEventListener('input', trigger); startInput.addEventListener('change', trigger) }
                            if(endInput){ endInput.addEventListener('input', trigger); endInput.addEventListener('change', trigger) }
                            if(clearBtn){ clearBtn.addEventListener('click', function(){ if(qBox) qBox.value=''; if(roleSel) roleSel.value=''; if(startInput) startInput.value=''; if(endInput) endInput.value=''; trigger(); }) }
                            poll();
                            window.inboxPollTimer = setInterval(poll, 5000);
                        })();
                    </script>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded',function(){
            var sel=document.getElementById('selectAll');
            if(sel){sel.addEventListener('change',function(){document.querySelectorAll('input[name="ids"]').forEach(function(c){c.checked=sel.checked})})}
            function getCookie(name){var v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop():''}
            document.querySelectorAll('.modal').forEach(function(mdl){
                mdl.addEventListener('shown.bs.modal', function(ev){
                    var id = this.id.replace('view','');
                    if(!id) return;
                    fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:'read'})}).catch(function(){})
                });
            });
            var rows=document.getElementById('inboxRows');
            var mods=document.getElementById('modalsContainer');
            var qBox=document.getElementById('searchBox');
            function badge(v, yes, no){return v? '<span class="badge bg-'+yes+'">'+yes[0].toUpperCase()+yes.slice(1)+'</span>' : '<span class="badge bg-'+no+'">'+(no==='warning text-dark'?'Unresolved':'Unread')+'</span>'}
            function render(data){
                document.getElementById('stTotal').textContent=data.stats.total;
                document.getElementById('stRead').textContent=data.stats.read;
                document.getElementById('stUnread').textContent=data.stats.unread;
                document.getElementById('stResolved').textContent=data.stats.resolved;
                document.getElementById('stUnresolved').textContent=data.stats.unresolved;
                document.getElementById('stDeleted').textContent=data.stats.deleted;
                var html=''; var mod='';
                data.messages.forEach(function(m,i){
                    html += '<tr class="'+(m.is_read?'read':'unread')+'">\n'
                         + '<td>'+(i+1)+'</td>'
                         + '<td><input type="checkbox" name="ids" form="bulkForm" value="'+m.id+'"></td>'
                         + '<td>'+m.username+'</td>'
                         + '<td>'+m.email+'</td>'
                         + '<td>'+m.subject+'</td>'
                         + '<td>'+m.created_at+'</td>'
                         + '<td>'+(m.is_read? '<span class="badge bg-success">Read</span>' : '<span class="badge bg-secondary">Unread</span>') + (m.is_resolved? '<span class="badge bg-primary ms-1">Resolved</span>' : '<span class="badge bg-warning text-dark ms-1">Unresolved</span>') + '</td>'
                         + '<td><button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#view'+m.id+'">View</button> '
                         + '<a href="{% url 'inbox_delete_message' id=0 %}'.replace('0',m.id)+'" class="btn btn-sm btn-danger" onclick="return confirm(\'Delete this message?\')">Delete</a></td>'
                         + '</tr>';
                    mod += '<div class="modal fade" id="view'+m.id+'" tabindex="-1" aria-hidden="true">\n'
                         + '<div class="modal-dialog"><div class="modal-content">\n'
                         + '<div class="modal-header"><h5 class="modal-title">Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>\n'
                         + '<div class="modal-body">\n'
                         + '<div>Username: '+m.username+'</div><div>Email: '+m.email+'</div><div>Role: '+m.user_role+'</div><div>Sent: '+m.created_at+'</div><hr>\n'
                         + '<div><strong>Subject:</strong> '+(m.subject||'(no subject)')+'</div><div>'+m.message+'</div>\n'
                         + '</div>\n'
                         + '<div class="modal-footer">\n'
                         + '<div class="btn-group">\n'
                         + '<button data-id="'+m.id+'" data-action="read" class="btn btn-outline-success js-inbox-action" type="button">Read</button>\n'
                         + '<button data-id="'+m.id+'" data-action="unread" class="btn btn-outline-secondary js-inbox-action" type="button">Unread</button>\n'
                         + '<button data-id="'+m.id+'" data-action="resolve" class="btn btn-outline-primary js-inbox-action" type="button">Resolve</button>\n'
                         + '<button data-id="'+m.id+'" data-action="unresolve" class="btn btn-outline-warning js-inbox-action" type="button">Unresolve</button>\n'
                         + '</div></div></div></div></div>';
                });
                rows.innerHTML=html; mods.innerHTML=mod;
                mods.querySelectorAll('.modal').forEach(function(mdl){
                    mdl.addEventListener('shown.bs.modal', function(){
                        var id=this.id.replace('view','');
                        fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:'read'})}).catch(function(){})
                    });
                });
                mods.querySelectorAll('.js-inbox-action').forEach(function(btn){
                    btn.addEventListener('click', function(){
                        var id=this.getAttribute('data-id'); var a=this.getAttribute('data-action');
                        fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:a})}).then(function(){poll()}).catch(function(){});
                    });
                });
            }
            function buildQuery(){
                var q = qBox ? qBox.value.trim() : '';
                var role = document.getElementById('roleFilter') ? document.getElementById('roleFilter').value : '';
                var start = document.getElementById('startFilter') ? document.getElementById('startFilter').value : '';
                var end = document.getElementById('endFilter') ? document.getElementById('endFilter').value : '';
                var p = new URLSearchParams();
                if(q) p.set('q', q);
                if(role) p.set('role', role);
                if(start) p.set('start', start);
                if(end) p.set('end', end);
                return p.toString();
            }
            function poll(){
                var qs = buildQuery();
                var url = '{% url 'inbox_data' %}' + (qs? ('?'+qs):'');
                fetch(url).then(function(r){return r.json()}).then(function(data){if(data&&data.ok) render(data)}).catch(function(){});
            }
            var debounce;
            function trigger(){ clearTimeout(debounce); debounce=setTimeout(poll,250) }
            if(qBox){ qBox.addEventListener('input', trigger) }
            var roleSel=document.getElementById('roleFilter'); if(roleSel){ roleSel.addEventListener('change', trigger) }
            var startInput=document.getElementById('startFilter'); if(startInput){ startInput.addEventListener('input', trigger); startInput.addEventListener('change', trigger) }
            var endInput=document.getElementById('endFilter'); if(endInput){ endInput.addEventListener('input', trigger); endInput.addEventListener('change', trigger) }
            var clearBtn=document.getElementById('clearFilters'); if(clearBtn){ clearBtn.addEventListener('click', function(){ if(qBox) qBox.value=''; if(roleSel) roleSel.value=''; if(startInput) startInput.value=''; if(endInput) endInput.value=''; trigger(); }) }
            if(!window.inboxPollTimer){window.inboxPollTimer=setInterval(poll,5000);} 
            poll();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
                    <div class="alert alert-info mt-2 mb-0">
                        Enter date/time as <strong>YYYY-MM-DD HH:MM</strong> or <strong>YYYY-MM-DDTHH:MM</strong>. Example: <code>2025-11-26 14:30</code>
                    </div>
