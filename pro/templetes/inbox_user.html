<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Inbox</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <style>:root{--radius:.9rem}.card{border-radius:var(--radius)}.unread{background:rgba(34,197,94,.08)}.read{background:transparent}</style>
</head>
<body style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">
    <style>
        .modal{z-index:11000}
        .modal-backdrop{z-index:10900}
    </style>
    {% include 'partials/navbar.html' %}
    <div id="spa-content">
    <div class="container py-4">
        <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="h5 mb-1">{{ user.username|default:user.email }}</div>
                    <div class="text-secondary">{{ user.email }}</div>
                </div>
                <div class="d-flex gap-2">
                    <form method="post" action="{% url 'inbox_delete_user' user_id=user.id %}">{% csrf_token %}<button class="btn btn-danger" onclick="return confirm('Delete all messages for this user?')">Delete All</button></form>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-3">
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Total: {{ stats.total }}</div></div>
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Read: {{ stats.read }}</div></div>
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Unread: {{ stats.unread }}</div></div>
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Resolved: {{ stats.resolved }}</div></div>
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Unresolved: {{ stats.unresolved }}</div></div>
            <div class="col-6 col-md-2"><div class="p-3 border rounded-3">Deleted: {{ stats.deleted }}</div></div>
        </div>
        <div class="card p-3">
            <form id="bulkForm" method="post" action="{% url 'inbox_bulk_action' %}">
                {% csrf_token %}
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="d-flex gap-2">
                        <select name="action" class="form-select" style="max-width: 200px">
                            <option value="read">Mark Read</option>
                            <option value="unread">Mark Unread</option>
                            <option value="resolve">Resolve</option>
                            <option value="unresolve">Unresolve</option>
                            <option value="delete">Delete</option>
                        </select>
                        <button type="submit" class="btn btn-outline-primary">Apply</button>
                    </div>
                    <input type="checkbox" id="selectAll">
                </div>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th></th>
                                <th>Sent</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in messages_list %}
                            <tr class="{% if not m.is_read %}unread{% else %}read{% endif %}">
                                <td>{{ forloop.counter }}</td>
                                <td><input type="checkbox" name="ids" form="bulkForm" value="{{ m.id }}"></td>
                                <td>{{ m.created_at }}</td>
                                <td>{{ m.subject|default:'-' }}</td>
                                <td>
                                    {% if m.is_read %}<span class="badge bg-success">Read</span>{% else %}<span class="badge bg-secondary">Unread</span>{% endif %}
                                    {% if m.is_resolved %}<span class="badge bg-primary ms-1">Resolved</span>{% else %}<span class="badge bg-warning text-dark ms-1">Unresolved</span>{% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#view{{ m.id }}">View</button>
                                    <a href="{% url 'inbox_delete_message' id=m.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this message?')">Delete</a>
                                </td>
                            </tr>
                            <div class="modal fade" id="view{{ m.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header"><h5 class="modal-title">Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                        <div class="modal-body">
                                            <div>Username: {{ user.username|default:user.email }}</div>
                                            <div>Email: {{ user.email }}</div>
                                            <div>Role: {{ user.role }}</div>
                                            <div>Sent: {{ m.created_at }}</div>
                                            <hr>
                                            <div><strong>Subject:</strong> {{ m.subject|default:'(no subject)' }}</div>
                                            <div>{{ m.message|linebreaks }}</div>
                                        </div>
                                        <div class="modal-footer">
                                            <form method="post" action="{% url 'inbox_bulk_action' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="ids" value="{{ m.id }}">
                                                <div class="btn-group">
                                                    <button name="action" value="read" class="btn btn-outline-success" type="submit">Read</button>
                                                    <button name="action" value="unread" class="btn btn-outline-secondary" type="submit">Unread</button>
                                                    <button name="action" value="resolve" class="btn btn-outline-primary" type="submit">Resolve</button>
                                                    <button name="action" value="unresolve" class="btn btn-outline-warning" type="submit">Unresolve</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded',function(){
            var sel=document.getElementById('selectAll');
            if(sel){sel.addEventListener('change',function(){document.querySelectorAll('input[name="ids"]').forEach(function(c){c.checked=sel.checked})})}
            function getCookie(name){var v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop():''}
            document.querySelectorAll('.modal').forEach(function(mdl){
                mdl.addEventListener('shown.bs.modal', function(ev){
                    var id = this.id.replace('view','');
                    if(!id) return;
                    fetch('{% url 'inbox_bulk_action' %}',{method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({ids:id, action:'read'})}).catch(function(){})
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
