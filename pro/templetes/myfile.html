<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--radius:.9rem}
        body{opacity:0;animation:fadeIn .15s ease forwards}
        @keyframes fadeIn{to{opacity:1}}
        body::before{content:"";position:fixed;inset:-15% -10%;z-index:-1;filter:blur(45px);
            background: radial-gradient(40% 40% at 10% 20%, rgba(99,102,241,.25) 0%, transparent 60%),
                        radial-gradient(40% 40% at 90% 10%, rgba(34,211,238,.25) 0%, transparent 60%);
            animation: floatBg 14s ease-in-out infinite alternate}
        @keyframes floatBg{from{transform:translate3d(0,0,0)}to{transform:translate3d(0,-6%,0)}}
        .navbar{backdrop-filter:blur(6px);position:relative;z-index:6000}
        .card{border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.08)}
        .glass{background:rgba(255,255,255,.75)}
        [data-bs-theme="dark"] .glass{background:rgba(25,25,28,.55)}
        .hero{border-radius:var(--radius);padding:2rem;background:linear-gradient(135deg,#22d3ee,#6366f1);color:#fff;box-shadow:0 12px 32px rgba(99,102,241,.25)}
        .panel{display:grid;grid-template-columns:1fr;gap:1rem}
        @media (min-width: 768px){.panel{grid-template-columns:1fr auto}}
        .table thead th{font-weight:600}
        .table-hover tbody tr{transition:background-color .15s ease}
        .btn-link{padding:0}
        #pageLoader{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.06);z-index:9999}
        .show-loader #pageLoader{display:grid}
        .dropdown-menu{z-index:7000}
        .modal{z-index:9999}
        .modal-backdrop{z-index:9998}
        .search-modern{max-width:360px;border-radius:999px;padding:.6rem 1rem;border:1px solid rgba(0,0,0,.08);box-shadow:0 8px 22px rgba(0,0,0,.06);transition:box-shadow .2s ease, transform .15s ease}
        .search-modern:focus{outline:none;box-shadow:0 12px 26px rgba(99,102,241,.18);transform:translateY(-1px)}
        [data-bs-theme="dark"] .search-modern{border-color:rgba(255,255,255,.12);box-shadow:0 8px 22px rgba(0,0,0,.35)}
        .btn-gradient{border:none;border-radius:999px;padding:.55rem 1rem;background:linear-gradient(90deg,#22d3ee,#6366f1);color:#fff;box-shadow:0 10px 20px rgba(99,102,241,.3);transition:transform .15s ease, box-shadow .2s ease}
        .btn-gradient:hover{transform:translateY(-1px);box-shadow:0 16px 28px rgba(99,102,241,.35)}
        .responsive-table{--pad:.75rem}
        @media (max-width: 576px){
            .responsive-table table{display:block}
            .responsive-table thead{display:none}
            .responsive-table tbody{display:grid;gap:.75rem}
            .responsive-table tbody tr{display:grid;background:var(--bs-body-bg);border:1px solid rgba(0,0,0,.06);border-radius:var(--radius);padding:var(--pad)}
            .responsive-table td,.responsive-table th{display:flex;justify-content:space-between;align-items:center;border:none;padding:.25rem .5rem}
        }
    </style>
</head>
<body>
{% include 'partials/navbar.html' %}
<div id="spa-content">

    <div class="container py-4">
        <div class="hero mb-4">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
                <div>
                    <div class="h1 mb-1">Dashboard</div>
                    <div class="opacity-75">Manage customers, roles and statuses</div>
                </div>
                <div class="d-flex gap-2">
                    {% if current_role == 'admin' or current_role == 'manager' %}
                    <a href="{% url 'stats' %}" class="btn btn-light" data-loader>Stats</a>
                    <a href="{% url 'inbox' %}" class="btn btn-light" data-loader>Inbox</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-12">
                <div class="card glass">
                    <div class="card-body">
                        {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags|default:'info' }}" role="alert">{{ message }}</div>
                        {% endfor %}
                        {% endif %}
                        <div class="panel mb-3">
                            <div class="d-flex align-items-center gap-3">
                                <h2 class="h4 mb-0">Customers</h2>
                                <span class="badge bg-primary" id="totalUsers">{{ counts.total }} Total</span>
                                <span class="badge bg-success" id="activeUsers">{{ counts.active }} Active</span>
                                <span class="badge bg-secondary" id="inactiveUsers">{{ counts.inactive }} Inactive</span>
                            </div>
                            <div class="d-flex flex-wrap align-items-center gap-2 justify-content-md-end">
                                <input type="search" class="search-modern" id="liveSearch" value="{{q}}" placeholder="Search users" />
                                {% if current_role == 'admin' or current_role == 'manager' %}
                                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addUserModal">Add user</button>
                                {% endif %}
                            </div>
                        </div>
                        {% if current_role == 'admin' %}
                        <form method="post" action="{% url 'bulk_action' %}" class="mb-3">
                            {% csrf_token %}
                            <div class="d-flex align-items-center gap-2">
                                <select name="action" class="form-select" style="max-width: 200px" form="bulkFormProxy">
                                    <option value="make_user">Make User</option>
                                    <option value="make_manager">Make Manager</option>
                                    <option value="make_admin">Make Admin</option>
                                    <option value="delete">Delete Selected</option>
                                    <option value="activate">Activate Selected</option>
                                    <option value="deactivate">Deactivate Selected</option>
                                </select>
                                <button type="submit" class="btn btn-outline-primary" form="bulkFormProxy">Apply</button>
                            </div>
                            <div class="small text-secondary mt-1">Use the checkboxes to select users</div>
                        </form>
                        {% endif %}
                        <div class="table-responsive responsive-table">
                            <table class="table table-striped table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        {% if current_role == 'admin' %}
                                        <th><input type="checkbox" id="selectAll"></th>
                                        {% endif %}
                                        <th>Username</th>
                                        <th class="d-none d-sm-table-cell">Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="userRows">
                                    {% for ob in obj %}
                                    <tr>
                                        <th scope="row">{{ forloop.counter }}</th>
                                        {% if current_role == 'admin' %}
                                        <td><input type="checkbox" name="ids" form="bulkFormProxy" value="{{ob.pk}}"></td>
                                        {% endif %}
                                        <td>{{ob.username}}</td>
                                        <td class="d-none d-sm-table-cell">{{ob.email}}</td>
                                        <td class="text-capitalize">{{ob.role}}</td>
                                        <td>
                                            {% if current_role == 'admin' or current_role == 'manager' %}
                                                {% if ob.pk == current_user.pk %}
                                                <span class="badge {% if ob.is_active %}bg-success{% else %}bg-secondary{% endif %}" title="You cannot change your own status">{{ ob.is_active|yesno:"Active,Inactive" }} ðŸ”’</span>
                                                {% else %}
                                                <input type="checkbox" class="form-check-input status-toggle" data-id="{{ob.pk}}" {% if ob.is_active %}checked{% endif %}>
                                                {% endif %}
                                            {% else %}
                                            <span class="badge {% if ob.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{ ob.is_active|yesno:"Active,Inactive" }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if current_role == 'admin' or current_role == 'manager' %}
                                            <a href="{% url 'update' id=ob.pk %}" class="btn btn-sm btn-light" data-loader>Update</a>
                                            {% endif %}
                                            {% if current_role == 'admin' %}
                                                {% if ob.pk == current_user.pk %}
                                                <button class="btn btn-sm btn-danger" disabled title="You cannot delete your own account">ðŸ”’ Delete</button>
                                                {% else %}
                                                <a href="{% url 'del' id=ob.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('Are You Sure To Delete This Record.')">Delete</a>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if current_role == 'admin' %}
    <form id="bulkFormProxy" method="post" action="{% url 'bulk_action' %}">{% csrf_token %}</form>
    {% endif %}
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'create_user' %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label" for="new_username">Username</label>
                            <input id="new_username" name="Username" type="text" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="new_email">Email</label>
                            <input id="new_email" name="Email" type="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="new_password">Password</label>
                            <input id="new_password" name="Password" type="password" class="form-control" required>
                        </div>
                        {% if current_role == 'admin' %}
                        <div class="mb-3">
                            <label class="form-label" for="new_role">Role</label>
                            <select id="new_role" name="Role" class="form-select">
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="pageLoader"><div class="spinner-border text-primary" role="status" aria-label="Loading"></div></div>
    </div>
    <script data-spa-init>
        (function(){
            var rows=document.getElementById('userRows');
            if(!rows || rows.dataset.init==='1') return; rows.dataset.init='1';
            var selAll=document.getElementById('selectAll');
            if(selAll){ selAll.addEventListener('change',function(){ document.querySelectorAll('input[name="ids"]').forEach(function(c){ c.checked=selAll.checked }) }) }
            var role="{{current_role}}";
            var upBase="{% url 'update' id=0 %}";
            var delBase="{% url 'del' id=0 %}";
            function getCookie(name){var v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop():''}
            function bindStatus(){
                document.querySelectorAll('.status-toggle').forEach(function(chk){
                    chk.addEventListener('change',function(){
                        var id=this.getAttribute('data-id'); var active=this.checked? '1':'0';
                        fetch("{% url 'toggle_status' %}",{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:new URLSearchParams({id:id,is_active:active})})
                            .then(function(r){ if(!r.ok){ throw new Error('fail') } return r.json() })
                            .catch(function(){ chk.checked=!chk.checked });
                    });
                });
            }
            function updateCounters(){
                var rs=document.querySelectorAll('#userRows tr');
                var total=rs.length; var active=0; var inactive=0;
                rs.forEach(function(r){
                    var own=r.querySelector('.badge');
                    if(own){ if(own.textContent.indexOf('Active')>-1) active++; else inactive++; }
                    else{ var chk=r.querySelector('.status-toggle'); if(chk){ if(chk.checked) active++; else inactive++; } }
                });
                var t=document.getElementById('totalUsers'); if(t) t.textContent=total+' Total';
                var a=document.getElementById('activeUsers'); if(a) a.textContent=active+' Active';
                var i=document.getElementById('inactiveUsers'); if(i) i.textContent=inactive+' Inactive';
            }
            function render(data, actingId){
                var h='';
                data.forEach(function(o,idx){
                    h+= '<tr>'+
                         '<th scope="row">'+(idx+1)+'</th>'+
                         (role==='admin'? '<td><input type="checkbox" name="ids" form="bulkFormProxy" value="'+o.id+'"></td>' : '')+
                         '<td>'+ (o.username||'') +'</td>'+
                         '<td>'+ (o.email||'') +'</td>'+
                         '<td class="text-capitalize">'+ (o.role||'') +'</td>'+
                         '<td>'+ ((role==='admin'||role==='manager')? (o.id==actingId? '<span class="badge '+(o.is_active? 'bg-success':'bg-secondary')+'" title="You cannot change your own status">'+(o.is_active? 'Active':'Inactive')+' ðŸ”’</span>' : '<input type="checkbox" class="form-check-input status-toggle" data-id="'+o.id+'" '+(o.is_active? 'checked':'')+'>') : '<span class="badge '+(o.is_active? 'bg-success':'bg-secondary')+'">'+(o.is_active? 'Active':'Inactive')+'</span>') +'</td>'+
                         '<td>'+
                           ((role==='admin'||role==='manager')? '<a href="'+ upBase.replace('0', o.id) +'" class="btn btn-sm btn-light" data-loader>Update</a>' : '')+
                           (role==='admin'? (o.id==actingId? ' <button class="btn btn-sm btn-danger" disabled title="You cannot delete your own account">ðŸ”’ Delete</button>' : ' <a href="'+ delBase.replace('0', o.id) +'" class="btn btn-sm btn-danger" onclick="return confirm(\'Are You Sure To Delete This Record.\')">Delete</a>') : '')+
                         '</td>'+
                       '</tr>';
                });
                rows.innerHTML=h; bindStatus(); updateCounters();
            }
            function debounce(fn,ms){var t;return function(){clearTimeout(t);var a=arguments;t=setTimeout(function(){fn.apply(null,a)},ms)}}
            var input=document.getElementById('liveSearch');
            var doSearch=debounce(function(){ var q=input.value.trim(); fetch('?q='+encodeURIComponent(q)+'&format=json',{headers:{'X-Requested-With':'XMLHttpRequest'}}).then(function(r){return r.json()}).then(function(j){render(j.results, j.acting_id)}) },180);
            if(input){ input.addEventListener('input',doSearch) }
            bindStatus(); updateCounters();
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded',function(){
            var loader=document.getElementById('pageLoader');
            var selAll=document.getElementById('selectAll');
            if(selAll){
                selAll.addEventListener('change',function(){
                    document.querySelectorAll('input[name="ids"]').forEach(function(c){c.checked=selAll.checked});
                });
            }
            function show(){document.body.classList.add('show-loader')}
            document.querySelectorAll('a[data-loader]').forEach(function(a){a.addEventListener('click',show)});
            function hide(){document.body.classList.remove('show-loader')}
            hide();
            window.addEventListener('load', hide);
            window.addEventListener('pageshow', hide);
            var role="{{current_role}}";
            var rows=document.getElementById('userRows');
            var upBase="{% url 'update' id=0 %}";
            var delBase="{% url 'del' id=0 %}";
            function render(data, actingId){
                var h='';
                data.forEach(function(o,idx){
                    h+= '<tr>'+
                         '<th scope="row">'+(idx+1)+'</th>'+
                         (role==='admin'? '<td><input type="checkbox" name="ids" form="bulkFormProxy" value="'+o.id+'"></td>' : '')+
                         '<td>'+ (o.username||'') +'</td>'+
                         '<td>'+ (o.email||'') +'</td>'+
                         '<td class="text-capitalize">'+ (o.role||'') +'</td>'+
                         '<td>'+ ((role==='admin'||role==='manager')? (o.id==actingId? '<span class="badge '+(o.is_active? 'bg-success':'bg-secondary')+'" title="You cannot change your own status">'+(o.is_active? 'Active':'Inactive')+' ðŸ”’</span>' : '<input type="checkbox" class="form-check-input status-toggle" data-id="'+o.id+'" '+(o.is_active? 'checked':'')+'>') : '<span class="badge '+(o.is_active? 'bg-success':'bg-secondary')+'">'+(o.is_active? 'Active':'Inactive')+'</span>') +'</td>'+
                         '<td>'+
                           ((role==='admin'||role==='manager')? '<a href="'+ upBase.replace('0', o.id) +'" class="btn btn-sm btn-light" data-loader>Update</a>' : '')+
                           (role==='admin'? (o.id==actingId? ' <button class="btn btn-sm btn-danger" disabled title="You cannot delete your own account">ðŸ”’ Delete</button>' : ' <a href="'+ delBase.replace('0', o.id) +'" class="btn btn-sm btn-danger" onclick="return confirm(\'Are You Sure To Delete This Record.\')">Delete</a>') : '')+
                         '</td>'+
                       '</tr>';
                });
                rows.innerHTML=h;
                bindStatus()
                updateCounters()
            }
            function getCookie(name){var v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop():''}
            function bindStatus(){
                document.querySelectorAll('.status-toggle').forEach(function(chk){
                    chk.addEventListener('change',function(){
                        var id=this.getAttribute('data-id');
                        var active=this.checked? '1':'0';
                        fetch("{% url 'toggle_status' %}",{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:new URLSearchParams({id:id,is_active:active})})
                            .then(function(r){ if(!r.ok){ throw new Error('Failed') } return r.json()})
                            .catch(function(){ chk.checked=!chk.checked });
                    });
                });
            }
            function debounce(fn,ms){var t;return function(){clearTimeout(t);var a=arguments;t=setTimeout(function(){fn.apply(null,a)},ms)}}
            var input=document.getElementById('liveSearch');
            var doSearch=debounce(function(){
                var q=input.value.trim();
                fetch('?q='+encodeURIComponent(q)+'&format=json',{headers:{'X-Requested-With':'XMLHttpRequest'}})
                    .then(function(r){return r.json()})
                    .then(function(j){render(j.results, j.acting_id)});
            },180);
            if(input){
                input.addEventListener('input',doSearch);
            }
            function updateCounters(){
                var rs=document.querySelectorAll('#userRows tr');
                var total=rs.length; var active=0; var inactive=0;
                rs.forEach(function(r){
                    var own=r.querySelector('.badge');
                    if(own){ if(own.textContent.indexOf('Active')>-1) active++; else inactive++; }
                    else{ var chk=r.querySelector('.status-toggle'); if(chk){ if(chk.checked) active++; else inactive++; } }
                });
                var t=document.getElementById('totalUsers'); if(t) t.textContent=total+' Total';
                var a=document.getElementById('activeUsers'); if(a) a.textContent=active+' Active';
                var i=document.getElementById('inactiveUsers'); if(i) i.textContent=inactive+' Inactive';
            }
            bindStatus();
            updateCounters();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
